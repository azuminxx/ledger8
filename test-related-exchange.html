<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>関連フィールド一括交換テスト</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f5f5f5; }
        .primary-key { background-color: #fff3e0; font-weight: bold; }
        .test-section { margin: 20px 0; padding: 15px; border: 2px solid #e0e0e0; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
        .error { background-color: #ffe8e8; border-left: 4px solid #f44336; }
        .info { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
        
        /* 主キー未紐づきフィールド用スタイル */
        .cell-unlinked-ledger {
            background-color: #f5f5f5 !important;
        }
        
        /* ユーザーから隠すフィールド用スタイル（DOM上には存在、視覚的に非表示） */
        .cell-hidden-from-user {
            width: 1px !important;
            min-width: 1px !important;
            max-width: 1px !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            overflow: hidden !important;
            font-size: 0 !important;
            color: transparent !important;
            background: transparent !important;
            opacity: 0.01 !important;
            pointer-events: none !important;
        }
        
        /* ヘッダーでもユーザーから隠すフィールド用スタイル */
        .header-hidden-from-user {
            width: 1px !important;
            min-width: 1px !important;
            max-width: 1px !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            overflow: hidden !important;
            font-size: 0 !important;
            color: transparent !important;
            background: transparent !important;
            opacity: 0.01 !important;
        }
    </style>
</head>
<body>
    <h1>🔄 主キー交換時の関連フィールド一括交換テスト</h1>
    
    <div class="test-section">
        <h2>📋 テストシナリオ</h2>
        <ol>
            <li><strong>座席番号の交換</strong>: A-001 ⇔ B-002 を交換すると、座席台帳の関連フィールドもすべて交換される</li>
            <li><strong>PC番号の交換</strong>: PC-001 ⇔ PC-002 を交換すると、PC台帳の関連フィールドもすべて交換される</li>
            <li><strong>レコードID交換</strong>: 主キー交換時にレコードIDも同時に交換される</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>🧪 テストデータ</h2>
        <table id="test-table">
            <thead>
                <tr>
                    <th>行番号</th>
                    <th class="primary-key">座席番号 [SEAT]</th>
                    <th class="primary-key">PC番号 [PC]</th>
                    <th>座席エリア [SEAT]</th>
                    <th>PC用途 [PC]</th>
                    <th>SEAT-ID</th>
                    <th>PC-ID</th>
                </tr>
            </thead>
            <tbody>
                <tr data-row-id="1" data-integration-key="SEAT:A-001|PC:PC-001">
                    <td>1</td>
                    <td class="primary-key" data-field-code="座席番号" data-is-primary-key="true" draggable="true">
                        <div style="display: flex; align-items: center;">
                            <span>A-001</span>
                        </div>
                    </td>
                    <td class="primary-key" data-field-code="PC番号" data-is-primary-key="true" draggable="true">
                        <div style="display: flex; align-items: center;">
                            <span>PC-002</span>
                        </div>
                    </td>
                    <td data-field-code="座席エリア">フロア1-北</td>
                    <td data-field-code="PC用途">個人専用</td>
                    <td data-field-code="seat_record_id">SEAT-12345</td>
                    <td data-field-code="pc_record_id">PC-67890</td>
                </tr>
                <tr data-row-id="2" data-integration-key="SEAT:B-002|PC:PC-002">
                    <td>2</td>
                    <td class="primary-key" data-field-code="座席番号" data-is-primary-key="true" draggable="true">
                        <div style="display: flex; align-items: center;">
                            <span>B-002</span>
                        </div>
                    </td>
                    <td class="primary-key" data-field-code="PC番号" data-is-primary-key="true" draggable="true">
                        <div style="display: flex; align-items: center;">
                            <span>PC-002</span>
                        </div>
                    </td>
                    <td data-field-code="座席エリア">フロア2-南</td>
                    <td data-field-code="PC用途">会議用</td>
                    <td data-field-code="seat_record_id">SEAT-54321</td>
                    <td data-field-code="pc_record_id">PC-09876</td>
                </tr>
                <tr data-row-id="3" data-integration-key="SEAT:C-003">
                    <td>3</td>
                    <td class="primary-key" data-field-code="座席番号" data-is-primary-key="true" draggable="true">
                        <div style="display: flex; align-items: center;">
                            <span>C-003</span>
                        </div>
                    </td>
                    <td class="primary-key" data-field-code="PC番号" data-is-primary-key="true" draggable="true">
                        <div style="display: flex; align-items: center;">
                            <span></span>
                        </div>
                    </td>
                    <td data-field-code="座席エリア">フロア3-東</td>
                    <td data-field-code="PC用途"></td>
                    <td data-field-code="seat_record_id">SEAT-98765</td>
                    <td data-field-code="pc_record_id"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>📝 テスト実行ログ</h2>
        <div id="test-log"></div>
        <button onclick="runTests()">🚀 テスト実行</button>
        <button onclick="clearLog()">🗑️ ログクリア</button>
        <button onclick="testUnlinkedLedgerStyle()">🎨 主キー紐づきテスト</button>
        <button onclick="testHiddenFields()">👁️‍🗨️ 隠しフィールドテスト</button>
    </div>

    <!-- v2のスクリプト読み込み -->
    <script src="v2/utils.js"></script>
    <script src="v2/table-render.js"></script>

    <script>
        // モックのfieldsConfig
        window.fieldsConfig = [
            { fieldCode: '座席番号', sourceApp: 'SEAT', isPrimaryKey: true },
            { fieldCode: 'PC番号', sourceApp: 'PC', isPrimaryKey: true },
            { fieldCode: '座席エリア', sourceApp: 'SEAT', isRecordId: false },
            { fieldCode: 'PC用途', sourceApp: 'PC', isRecordId: false },
            { fieldCode: 'seat_record_id', sourceApp: 'SEAT', isRecordId: true, isHiddenFromUser: true },
            { fieldCode: 'pc_record_id', sourceApp: 'PC', isRecordId: true, isHiddenFromUser: true }
        ];

        // モックのCellValueHelper
        window.CellValueHelper = {
            getValue: (cell) => {
                const span = cell.querySelector('span');
                return span ? span.textContent.trim() : cell.textContent.trim();
            },
            setValue: (cell, value) => {
                const span = cell.querySelector('span');
                if (span) {
                    span.textContent = value;
                } else {
                    cell.textContent = value;
                }
            }
        };

        // モックのCommonHighlightHelper
        window.CommonHighlightHelper = {
            updateMultipleCellsHighlight: (cells) => {
                cells.forEach(cell => {
                    cell.style.backgroundColor = '#fff3cd';
                });
                logResult('info', `ハイライト更新: ${cells.length}セルを更新`);
            }
        };

        // モックのLedgerV2名前空間
        window.LedgerV2 = {
            TableInteract: {}
        };

        // モックのFieldValueProcessor
        window.FieldValueProcessor = {
            process: (record, fieldCode, defaultValue) => {
                return record[fieldCode] || defaultValue;
            }
        };

        // モックのStyleManager
        window.StyleManager = {
            applyCellStyles: (cell, width) => {
                cell.style.width = width;
            }
        };

        // モックのDOMHelper
        window.DOMHelper = {
            getTableBody: () => document.querySelector('#test-table tbody')
        };

        function logResult(type, message) {
            const log = document.getElementById('test-log');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        async function runTests() {
            logResult('info', '🧪 テスト開始: 関連フィールド一括交換機能');
            
            try {
                // v2/cell-swap.jsを動的読み込み
                await loadScript('v2/cell-swap.js');
                
                // テスト1: 座席番号の関連フィールド取得テスト
                testGetRelatedFields();
                
                // テスト2: セル検索テスト
                testFindCellInRow();
                
                // テスト3: 単一フィールド交換テスト
                testExchangeSingleField();
                
                // テスト4: 空行判定テスト
                testEmptyRowDetection();
                
                // テスト5: 空行削除テスト（シミュレーション）
                testEmptyRowRemoval();
                
                logResult('success', '✅ 全テスト完了');
                
            } catch (error) {
                logResult('error', `❌ テストエラー: ${error.message}`);
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    logResult('success', `✅ スクリプト読み込み完了: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    logResult('error', `❌ スクリプト読み込み失敗: ${src}`);
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        function testGetRelatedFields() {
            logResult('info', '🔍 テスト1: 関連フィールド取得');
            
            const manager = new window.LedgerV2.TableInteract.CellSwapManager();
            
            // SEAT台帳の関連フィールド
            const seatFields = manager._getRelatedFields('SEAT');
            logResult('info', `SEAT関連フィールド: [${seatFields.join(', ')}]`);
            
            // PC台帳の関連フィールド
            const pcFields = manager._getRelatedFields('PC');
            logResult('info', `PC関連フィールド: [${pcFields.join(', ')}]`);
            
            if (seatFields.includes('座席エリア') && pcFields.includes('PC用途')) {
                logResult('success', '✅ 関連フィールド取得テスト: 成功');
            } else {
                logResult('error', '❌ 関連フィールド取得テスト: 失敗');
            }
        }

        function testFindCellInRow() {
            logResult('info', '🔍 テスト2: セル検索');
            
            const manager = new window.LedgerV2.TableInteract.CellSwapManager();
            const row = document.querySelector('tr[data-row-id="1"]');
            
            const seatCell = manager._findCellInRow(row, '座席番号');
            const pcCell = manager._findCellInRow(row, 'PC番号');
            
            if (seatCell && pcCell) {
                logResult('success', '✅ セル検索テスト: 成功');
                logResult('info', `座席番号セル値: ${window.CellValueHelper.getValue(seatCell)}`);
                logResult('info', `PC番号セル値: ${window.CellValueHelper.getValue(pcCell)}`);
            } else {
                logResult('error', '❌ セル検索テスト: 失敗');
            }
        }

        function testExchangeSingleField() {
            logResult('info', '🔍 テスト3: 単一フィールド交換');
            
            const manager = new window.LedgerV2.TableInteract.CellSwapManager();
            const row1 = document.querySelector('tr[data-row-id="1"]');
            const row2 = document.querySelector('tr[data-row-id="2"]');
            
            const seat1 = manager._findCellInRow(row1, '座席番号');
            const seat2 = manager._findCellInRow(row2, '座席番号');
            
            const before1 = window.CellValueHelper.getValue(seat1);
            const before2 = window.CellValueHelper.getValue(seat2);
            
            logResult('info', `交換前: ${before1} ⇔ ${before2}`);
            
            // 交換実行
            manager._exchangeSingleField(seat1, seat2);
            
            const after1 = window.CellValueHelper.getValue(seat1);
            const after2 = window.CellValueHelper.getValue(seat2);
            
            logResult('info', `交換後: ${after1} ⇔ ${after2}`);
            
            if (after1 === before2 && after2 === before1) {
                logResult('success', '✅ 単一フィールド交換テスト: 成功');
            } else {
                logResult('error', '❌ 単一フィールド交換テスト: 失敗');
            }
        }

        function testEmptyRowDetection() {
            logResult('info', '🔍 テスト4: 空行判定');
            
            const manager = new window.LedgerV2.TableInteract.CellSwapManager();
            
            // 行1（値あり）の空行判定
            const row1 = document.querySelector('tr[data-row-id="1"]');
            const isEmpty1 = manager._isRowEmpty(row1);
            logResult('info', `行1 空行判定: ${isEmpty1 ? '空行' : '値あり'}`);
            
            // 行3（座席のみ、PCは空）の空行判定
            const row3 = document.querySelector('tr[data-row-id="3"]');
            const isEmpty3 = manager._isRowEmpty(row3);
            logResult('info', `行3 空行判定: ${isEmpty3 ? '空行' : '値あり'}`);
            
            // 空行テスト用の行を作成
            const emptyRow = createEmptyTestRow();
            const isEmptyTest = manager._isRowEmpty(emptyRow);
            logResult('info', `テスト空行 判定: ${isEmptyTest ? '空行' : '値あり'}`);
            
            if (!isEmpty1 && !isEmpty3 && isEmptyTest) {
                logResult('success', '✅ 空行判定テスト: 成功');
            } else {
                logResult('error', '❌ 空行判定テスト: 失敗');
            }
        }

        function testEmptyRowRemoval() {
            logResult('info', '🔍 テスト5: 空行削除（シミュレーション）');
            
            const manager = new window.LedgerV2.TableInteract.CellSwapManager();
            
            // 空行テスト用の行を作成してテーブルに追加
            const emptyRow = createEmptyTestRow();
            emptyRow.setAttribute('data-row-id', '999');
            document.querySelector('#test-table tbody').appendChild(emptyRow);
            
            logResult('info', '空行をテーブルに追加');
            
            // 削除前の行数をカウント
            const rowsBefore = document.querySelectorAll('#test-table tbody tr').length;
            logResult('info', `削除前の行数: ${rowsBefore}`);
            
            // 空行削除実行
            manager._removeEmptyRowsAfterExchange([emptyRow]);
            
            // 削除後の行数をカウント
            const rowsAfter = document.querySelectorAll('#test-table tbody tr').length;
            logResult('info', `削除後の行数: ${rowsAfter}`);
            
            if (rowsAfter === rowsBefore - 1) {
                logResult('success', '✅ 空行削除テスト: 成功');
            } else {
                logResult('error', '❌ 空行削除テスト: 失敗');
            }
        }

        function createEmptyTestRow() {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>999</td>
                <td class="primary-key" data-field-code="座席番号" data-is-primary-key="true">
                    <div style="display: flex; align-items: center;">
                        <span></span>
                    </div>
                </td>
                <td class="primary-key" data-field-code="PC番号" data-is-primary-key="true">
                    <div style="display: flex; align-items: center;">
                        <span></span>
                    </div>
                </td>
                <td data-field-code="座席エリア"></td>
                <td data-field-code="PC用途"></td>
                <td data-field-code="seat_record_id"></td>
                <td data-field-code="pc_record_id"></td>
            `;
            return row;
        }

        function testUnlinkedLedgerStyle() {
            logResult('info', '🎨 主キー紐づきテスト開始');
            
            try {
                // テストデータ作成
                const testRecords = [
                    {
                        integrationKey: 'SEAT:A-001|PC:PC-001',
                        '座席番号': 'A-001',
                        'PC番号': 'PC-001',
                        '座席エリア': 'フロア1-北',
                        'PC用途': '個人専用',
                        'seat_record_id': 'SEAT-12345',
                        'pc_record_id': 'PC-67890'
                    },
                    {
                        integrationKey: 'SEAT:C-003',
                        '座席番号': 'C-003',
                        'PC番号': '', // 空の主キー
                        '座席エリア': 'フロア3-東',
                        'PC用途': '', // 空の関連フィールド
                        'seat_record_id': 'SEAT-98765',
                        'pc_record_id': '' // 空の関連フィールド
                    }
                ];
                
                // テーブル表示マネージャーを作成
                if (window.LedgerV2 && window.LedgerV2.TableRender && window.LedgerV2.TableRender.TableDisplayManager) {
                    const tableManager = new window.LedgerV2.TableRender.TableDisplayManager();
                    
                    // 各レコードに対してスタイル適用をテスト
                    testRecords.forEach((record, index) => {
                        const row = document.querySelector(`#test-table tbody tr[data-row-id="${index + 1}"]`);
                        if (row) {
                            // セルにdata-source-app属性を追加（テスト用）
                            const cells = row.querySelectorAll('td');
                            cells.forEach((cell, cellIndex) => {
                                const fieldCode = cell.getAttribute('data-field-code');
                                if (fieldCode) {
                                    const field = window.fieldsConfig.find(f => f.fieldCode === fieldCode);
                                    if (field && field.sourceApp) {
                                        cell.setAttribute('data-source-app', field.sourceApp);
                                    }
                                }
                            });
                            
                            // 主キー紐づきスタイルを適用
                            tableManager._applyUnlinkedLedgerStyles(row, record);
                            
                            logResult('success', `✅ 行${index + 1}: 主キー紐づきチェック完了`);
                        }
                    });
                    
                    // 結果確認
                    const unlinkedCells = document.querySelectorAll('.cell-unlinked-ledger');
                    logResult('info', `🎯 グレー背景セル数: ${unlinkedCells.length}個`);
                    
                    if (unlinkedCells.length > 0) {
                        logResult('success', '✅ 主キー未紐づきフィールドのグレー背景化成功！');
                    } else {
                        logResult('error', '❌ グレー背景が適用されませんでした');
                    }
                } else {
                    logResult('error', '❌ TableDisplayManagerが見つかりません');
                }
                
            } catch (error) {
                logResult('error', `❌ テストエラー: ${error.message}`);
                console.error('テストエラー詳細:', error);
            }
        }

        function testHiddenFields() {
            logResult('info', '👁️‍🗨️ 隠しフィールドテスト開始');
            
            try {
                // レコードIDフィールドをDOM上で確認
                const seatRecordIdCells = document.querySelectorAll('[data-field-code="seat_record_id"]');
                const pcRecordIdCells = document.querySelectorAll('[data-field-code="pc_record_id"]');
                
                logResult('info', `🔍 seat_record_id セル数: ${seatRecordIdCells.length}個`);
                logResult('info', `🔍 pc_record_id セル数: ${pcRecordIdCells.length}個`);
                
                // 隠しフィールドクラスを適用
                seatRecordIdCells.forEach(cell => {
                    cell.classList.add('cell-hidden-from-user');
                });
                pcRecordIdCells.forEach(cell => {
                    cell.classList.add('cell-hidden-from-user');
                });
                
                // 値を確認（DOM上には存在）
                seatRecordIdCells.forEach((cell, index) => {
                    const value = cell.textContent.trim();
                    logResult('success', `✅ seat_record_id[${index}] DOM値: "${value}" (視覚的に隠れている)`);
                });
                
                pcRecordIdCells.forEach((cell, index) => {
                    const value = cell.textContent.trim();
                    logResult('success', `✅ pc_record_id[${index}] DOM値: "${value}" (視覚的に隠れている)`);
                });
                
                // 視覚的な確認メッセージ
                if (seatRecordIdCells.length > 0 || pcRecordIdCells.length > 0) {
                    logResult('success', '✅ 隠しフィールド適用完了！レコードIDはDOM上に存在するが、ユーザーからは見えません');
                    logResult('info', '💡 開発者ツールで要素を確認すると、値は存在していることが確認できます');
                } else {
                    logResult('error', '❌ 隠しフィールドが見つかりませんでした');
                }
                
            } catch (error) {
                logResult('error', `❌ 隠しフィールドテストエラー: ${error.message}`);
                console.error('隠しフィールドテストエラー詳細:', error);
            }
        }
    </script>
</body>
</html> 