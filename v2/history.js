/* =============================================================================
   Êõ¥Êñ∞Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† - „É°„Ç§„É≥JavaScript
   ============================================================================= */

(function() {
    'use strict';

    // =============================================================================
    // üé® CSSÂüã„ÇÅËæº„ÅøÂá¶ÁêÜ
    // =============================================================================
    
    /**
     * Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†Â∞ÇÁî®CSS„ÇíÂãïÁöÑ„Å´ËøΩÂä†
     */
    function injectHistoryCSS() {
        // Êó¢„Å´CSS„ÅåËøΩÂä†„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
        if (document.getElementById('history-system-css')) {
            return;
        }
        
        const css = `
/* Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†Â∞ÇÁî®„Çπ„Çø„Ç§„É´ */
body[data-page="history"] {
    margin: 0 !important;
    padding: 0 !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    background-color: #f8f9fa !important;
    color: #333 !important;
    line-height: 1.6 !important;
}

body[data-page="history"] .main-header {
    background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
    color: white;
    padding: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
}

body[data-page="history"] .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    max-width: 1400px;
    margin: 0 auto;
}

body[data-page="history"] .system-title {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
}

body[data-page="history"] .main-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
}

body[data-page="history"] .stats-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

body[data-page="history"] .stat-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 16px;
}

body[data-page="history"] .stat-icon {
    font-size: 32px;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

body[data-page="history"] .stat-content {
    flex: 1;
}

body[data-page="history"] .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #1976d2;
    line-height: 1.2;
}

body[data-page="history"] .stat-label {
    font-size: 14px;
    color: #6c757d;
    font-weight: 500;
    margin-top: 4px;
}

body[data-page="history"] .filter-panel {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 24px;
}

body[data-page="history"] .filter-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

body[data-page="history"] .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

body[data-page="history"] .filter-label {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
}

body[data-page="history"] .radio-group {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

body[data-page="history"] .radio-option {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 14px;
}

body[data-page="history"] .table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

body[data-page="history"] .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
}

body[data-page="history"] .history-table {
    width: 100%;
    border-collapse: collapse;
}

body[data-page="history"] .history-table th,
body[data-page="history"] .history-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

body[data-page="history"] .history-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

body[data-page="history"] .history-table tbody tr:hover {
    background: #f8f9fa;
}

body[data-page="history"] .header-btn,
body[data-page="history"] .action-btn,
body[data-page="history"] .operation-btn,
body[data-page="history"] .btn {
    padding: 8px 16px;
    border: 1px solid #ced4da;
    background: white;
    color: #495057;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

body[data-page="history"] .header-btn:hover,
body[data-page="history"] .action-btn:hover,
body[data-page="history"] .operation-btn:hover,
body[data-page="history"] .btn:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
}

body[data-page="history"] .header-btn.primary,
body[data-page="history"] .btn.primary {
    background: #1976d2;
    color: white;
    border-color: #1976d2;
}

body[data-page="history"] .header-btn.primary:hover,
body[data-page="history"] .btn.primary:hover {
    background: #1565c0;
    border-color: #1565c0;
}

body[data-page="history"] .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
}

body[data-page="history"] .status-badge.not-required {
    background: #e9ecef;
    color: #6c757d;
}

body[data-page="history"] .status-badge.pending {
    background: #fff3cd;
    color: #856404;
}

body[data-page="history"] .status-badge.in-progress {
    background: #cce5ff;
    color: #0056b3;
}

body[data-page="history"] .status-badge.completed {
    background: #d4edda;
    color: #155724;
}

body[data-page="history"] .status-badge.overdue {
    background: #f8d7da;
    color: #721c24;
}

body[data-page="history"] .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
}

body[data-page="history"] .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    max-width: 90vw;
    max-height: 90vh;
    overflow: hidden;
}

body[data-page="history"] .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
}

body[data-page="history"] .modal-body {
    padding: 24px;
    max-height: 60vh;
    overflow-y: auto;
}

body[data-page="history"] .form-input,
body[data-page="history"] .form-textarea,
body[data-page="history"] .filter-select,
body[data-page="history"] .date-input,
body[data-page="history"] .search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 14px;
}

body[data-page="history"] .pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 30px 24px;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
    min-height: 108px;
    box-sizing: border-box;
}

body[data-page="history"] .pagination-info {
    font-size: 16px;
    color: #495057;
    font-weight: 500;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

body[data-page="history"] .pagination-info .info-label {
    font-size: 14px;
    color: #6c757d;
    font-weight: 400;
}

body[data-page="history"] .pagination-info .info-value {
    font-size: 18px;
    color: #1976d2;
    font-weight: 600;
}

body[data-page="history"] .pagination-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

body[data-page="history"] .search-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}

body[data-page="history"] .search-group {
    display: flex;
    gap: 8px;
    flex: 1;
    max-width: 400px;
}

body[data-page="history"] .date-range {
    display: flex;
    align-items: center;
    gap: 8px;
}

body[data-page="history"] .date-separator {
    color: #6c757d;
    font-weight: 500;
}

body[data-page="history"] .table-wrapper {
    overflow-x: auto;
}

body[data-page="history"] .table-actions {
    display: flex;
    gap: 12px;
}

body[data-page="history"] .header-right {
    display: flex;
    gap: 12px;
    align-items: center;
}

body[data-page="history"] .breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    opacity: 0.9;
}

body[data-page="history"] .breadcrumb-link {
    color: white;
    text-decoration: none;
}

body[data-page="history"] .breadcrumb-separator {
    opacity: 0.7;
}

body[data-page="history"] .breadcrumb-current {
    font-weight: 500;
}

/* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
@media (max-width: 768px) {
    body[data-page="history"] .header-content {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
    }
    
    body[data-page="history"] .stats-panel {
        grid-template-columns: 1fr;
    }
    
    body[data-page="history"] .filter-section {
        grid-template-columns: 1fr;
    }
    
    body[data-page="history"] .search-section {
        flex-direction: column;
        align-items: stretch;
    }
}
        `;
        
        const style = document.createElement('style');
        style.id = 'history-system-css';
        style.textContent = css;
        document.head.appendChild(style);
    }

    // =============================================================================
    // üåê „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    // =============================================================================
    
    let historyData = [];
    let filteredData = [];
    let currentPage = 1;
    let itemsPerPage = 50;
    let sortColumn = 'update_date';
    let sortDirection = 'desc';
    let selectedRows = new Set();
    let currentUser = null;
    let userTeam = null;

    // DOMË¶ÅÁ¥†
    const elements = {};

    // =============================================================================
    // üöÄ ÂàùÊúüÂåñ
    // =============================================================================

    /**
     * „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
     */
    function initHistorySystem() {
        console.log('üìã Êõ¥Êñ∞Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÈñãÂßã');
        
        // Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Éö„Éº„Ç∏„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
        if (!isHistoryPage()) {
            console.log('‚ÑπÔ∏è Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„Éö„Éº„Ç∏„Åß„ÅØ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÂàùÊúüÂåñ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô');
            return;
        }
        
        try {
            // CSS„ÇíÂãïÁöÑ„Å´ËøΩÂä†
            injectHistoryCSS();
            
            // body„Çø„Ç∞„Å´Â±•Ê≠¥„Ç∑„Çπ„ÉÜ„É†Ë≠òÂà•Â±ûÊÄß„ÇíËøΩÂä†
            document.body.setAttribute('data-page', 'history');
            document.body.classList.add('history-system-page');
            
            initDOMElements();
            setupEventListeners();
            initializeFilters();
            loadHistoryData();
        } catch (error) {
            console.error('‚ùå Êõ¥Êñ∞Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            return;
        }
        
        console.log('‚úÖ Êõ¥Êñ∞Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
    }

    /**
     * Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Éö„Éº„Ç∏„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
     */
    function isHistoryPage() {
        // Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†Â∞ÇÁî®„ÅÆË¶ÅÁ¥†„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        return document.getElementById('history-table') !== null ||
               document.querySelector('.stats-panel') !== null ||
               document.title.includes('Êõ¥Êñ∞Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†');
    }

    /**
     * DOMË¶ÅÁ¥†„ÇíÂèñÂæó
     */
    function initDOMElements() {
        // ÂøÖÈ†àË¶ÅÁ¥†„ÅÆÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ
        const requiredElements = ['history-table', 'history-table-body', 'stats-panel'];
        for (const elementId of requiredElements) {
            if (!document.getElementById(elementId) && !document.querySelector(`.${elementId}`)) {
                throw new Error(`ÂøÖÈ†àË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${elementId}`);
            }
        }
        
        elements.refreshBtn = document.getElementById('refresh-btn');
        elements.exportBtn = document.getElementById('export-btn');
        elements.backToMainBtn = document.getElementById('back-to-main-btn');
        
        // Áµ±Ë®àË¶ÅÁ¥†
        elements.totalUpdates = document.getElementById('total-updates');
        elements.pendingApplications = document.getElementById('pending-applications');
        elements.completedApplications = document.getElementById('completed-applications');
        elements.overdueApplications = document.getElementById('overdue-applications');
        
        // „Éï„Ç£„É´„ÇøË¶ÅÁ¥†
        elements.viewScopeRadios = document.querySelectorAll('input[name="view-scope"]');
        elements.dateFrom = document.getElementById('date-from');
        elements.dateTo = document.getElementById('date-to');
        elements.ledgerFilter = document.getElementById('ledger-filter');
        elements.applicationStatusFilter = document.getElementById('application-status-filter');
        elements.searchInput = document.getElementById('search-input');
        elements.searchBtn = document.getElementById('search-btn');
        elements.clearFiltersBtn = document.getElementById('clear-filters-btn');
        
        // „ÉÜ„Éº„Éñ„É´Ë¶ÅÁ¥†
        elements.historyTable = document.getElementById('history-table');
        elements.historyTableBody = document.getElementById('history-table-body');
        elements.selectAllCheckbox = document.getElementById('select-all-checkbox');
        elements.bulkApplicationBtn = document.getElementById('bulk-application-btn');
        elements.markCompletedBtn = document.getElementById('mark-completed-btn');
        
        // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Ë¶ÅÁ¥†
        elements.paginationInfoText = document.getElementById('pagination-info-text');
        elements.prevPageBtn = document.getElementById('prev-page-btn');
        elements.nextPageBtn = document.getElementById('next-page-btn');
        elements.pageNumbers = document.getElementById('page-numbers');
        
        // „É¢„Éº„ÉÄ„É´Ë¶ÅÁ¥†
        elements.applicationModal = document.getElementById('application-modal');
        elements.applicationModalClose = document.getElementById('application-modal-close');
        elements.applicationNumber = document.getElementById('application-number');
        elements.applicationDeadline = document.getElementById('application-deadline');
        elements.applicationNotes = document.getElementById('application-notes');
        elements.applicationCancelBtn = document.getElementById('application-cancel-btn');
        elements.applicationSaveBtn = document.getElementById('application-save-btn');
        
        elements.detailModal = document.getElementById('detail-modal');
        elements.detailModalClose = document.getElementById('detail-modal-close');
        elements.detailModalBody = document.getElementById('detail-modal-body');
        elements.detailCloseBtn = document.getElementById('detail-close-btn');
        
        elements.loadingOverlay = document.getElementById('loading-overlay');
    }

    /**
     * „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
     */
    function setupEventListeners() {
        // „Éò„ÉÉ„ÉÄ„Éº„Éú„Çø„É≥
        elements.refreshBtn.addEventListener('click', handleRefresh);
        elements.exportBtn.addEventListener('click', handleExport);
        elements.backToMainBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });
        
        // „Éï„Ç£„É´„Çø
        elements.viewScopeRadios.forEach(radio => {
            radio.addEventListener('change', handleViewScopeChange);
        });
        elements.dateFrom.addEventListener('change', applyFilters);
        elements.dateTo.addEventListener('change', applyFilters);
        elements.ledgerFilter.addEventListener('change', applyFilters);
        elements.applicationStatusFilter.addEventListener('change', applyFilters);
        elements.searchInput.addEventListener('input', debounce(applyFilters, 300));
        elements.searchBtn.addEventListener('click', applyFilters);
        elements.clearFiltersBtn.addEventListener('click', clearFilters);
        
        // „ÉÜ„Éº„Éñ„É´
        elements.selectAllCheckbox.addEventListener('change', handleSelectAll);
        elements.bulkApplicationBtn.addEventListener('click', handleBulkApplication);
        elements.markCompletedBtn.addEventListener('click', handleMarkCompleted);
        
        // „ÇΩ„Éº„Éà
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', handleSort);
        });
        
        // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥
        elements.prevPageBtn.addEventListener('click', () => changePage(currentPage - 1));
        elements.nextPageBtn.addEventListener('click', () => changePage(currentPage + 1));
        
        // „É¢„Éº„ÉÄ„É´
        elements.applicationModalClose.addEventListener('click', closeApplicationModal);
        elements.applicationCancelBtn.addEventListener('click', closeApplicationModal);
        elements.applicationSaveBtn.addEventListener('click', saveApplicationInfo);
        
        elements.detailModalClose.addEventListener('click', closeDetailModal);
        elements.detailCloseBtn.addEventListener('click', closeDetailModal);
        
        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        elements.applicationModal.addEventListener('click', (e) => {
            if (e.target === elements.applicationModal) closeApplicationModal();
        });
        elements.detailModal.addEventListener('click', (e) => {
            if (e.target === elements.detailModal) closeDetailModal();
        });
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', handleKeyDown);
    }

    /**
     * „Éï„Ç£„É´„Çø„ÇíÂàùÊúüÂåñ
     */
    function initializeFilters() {
        // ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíË®≠ÂÆö
        const today = new Date();
        const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
        
        elements.dateFrom.value = oneMonthAgo.toISOString().split('T')[0];
        elements.dateTo.value = today.toISOString().split('T')[0];
        
        // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæóÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØË™çË®º„Ç∑„Çπ„ÉÜ„É†„Åã„ÇâÂèñÂæóÔºâ
        currentUser = kintone.getLoginUser().name || 'Unknown User';
        userTeam = '„Éá„Éï„Ç©„É´„Éà„ÉÅ„Éº„É†'; // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åã„ÇâÂèñÂæó
    }

    // =============================================================================
    // üìä „Éá„Éº„ÇøÁÆ°ÁêÜ
    // =============================================================================

    /**
     * Â±•Ê≠¥„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
     */
    async function loadHistoryData() {
        showLoading(true);
        
        try {
            // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÂ±•Ê≠¥Âè∞Â∏≥„Ç¢„Éó„É™„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó
            // ÁèæÂú®„ÅØ„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíÁîüÊàê
            historyData = await fetchHistoryData();
            
            applyFilters();
            updateStatistics();
            
        } catch (error) {
            console.error('‚ùå Â±•Ê≠¥„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error);
            showError('Â±•Ê≠¥„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        } finally {
            showLoading(false);
        }
    }

    /**
     * Â±•Ê≠¥„Éá„Éº„Çø„ÇíÂèñÂæóÔºà„Çµ„É≥„Éó„É´ÂÆüË£ÖÔºâ
     */
    async function fetchHistoryData() {
        // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ kintone API „Çí‰ΩøÁî®
        return new Promise((resolve) => {
            setTimeout(() => {
                const sampleData = generateSampleHistoryData();
                resolve(sampleData);
            }, 1000);
        });
    }

    /**
     * „Çµ„É≥„Éó„É´Â±•Ê≠¥„Éá„Éº„Çø„ÇíÁîüÊàê
     */
    function generateSampleHistoryData() {
        const data = [];
        const ledgerTypes = ['SEAT', 'PC', 'EXT', 'USER'];
        const users = ['Áî∞‰∏≠Â§™ÈÉé', '‰ΩêËó§Ëä±Â≠ê', 'Èà¥Êú®‰∏ÄÈÉé', 'È´òÊ©ãÁæéÂí≤', currentUser];
        const statuses = ['not_required', 'pending', 'in_progress', 'completed', 'overdue'];
        
        for (let i = 0; i < 200; i++) {
            const updateDate = new Date();
            updateDate.setDate(updateDate.getDate() - Math.floor(Math.random() * 90));
            
            const ledgerType = ledgerTypes[Math.floor(Math.random() * ledgerTypes.length)];
            const updater = users[Math.floor(Math.random() * users.length)];
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            
            const record = {
                id: `hist_${i + 1}`,
                update_date: updateDate.toISOString(),
                updater: updater,
                ledger_type: ledgerType,
                record_key: generateRecordKey(ledgerType),
                changes: generateSampleChanges(ledgerType),
                application_status: status,
                application_number: status !== 'not_required' && Math.random() > 0.5 ? `APP-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}` : '',
                application_deadline: status === 'pending' || status === 'in_progress' ? generateDeadline() : '',
                notes: Math.random() > 0.7 ? '„Ç∑„Çπ„ÉÜ„É†Êõ¥Êñ∞„Å´‰º¥„ÅÜÂ§âÊõ¥' : ''
            };
            
            data.push(record);
        }
        
        return data.sort((a, b) => new Date(b.update_date) - new Date(a.update_date));
    }

    /**
     * „É¨„Ç≥„Éº„Éâ„Ç≠„Éº„ÇíÁîüÊàê
     */
    function generateRecordKey(ledgerType) {
        const keys = {
            'SEAT': () => `A-${Math.floor(Math.random() * 100) + 1}`,
            'PC': () => `PCAIT23N${String(Math.floor(Math.random() * 1000)).padStart(4, '0')}`,
            'EXT': () => String(Math.floor(Math.random() * 9000) + 1000),
            'USER': () => `user${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`
        };
        
        return keys[ledgerType] ? keys[ledgerType]() : 'UNKNOWN';
    }

    /**
     * „Çµ„É≥„Éó„É´Â§âÊõ¥ÂÜÖÂÆπ„ÇíÁîüÊàê
     */
    function generateSampleChanges(ledgerType) {
        const changes = {
            'SEAT': [
                { field: '„É¶„Éº„Ç∂„ÉºID', old: 'user001', new: 'user002' },
                { field: 'PCÁï™Âè∑', old: 'PCAIT23N0001', new: 'PCAIT23N0002' }
            ],
            'PC': [
                { field: 'PCÁî®ÈÄî', old: 'ÂÄã‰∫∫Â∞ÇÁî®', new: 'CO/TO„Éñ„Éº„Çπ' }
            ],
            'EXT': [
                { field: 'ÈõªË©±Ê©üÁ®ÆÂà•', old: '„Éì„Ç∏„Éç„Çπ', new: 'ACD' }
            ],
            'USER': [
                { field: '„É¶„Éº„Ç∂„ÉºÂêç', old: 'ÊóßÂêçÂâç', new: 'Êñ∞ÂêçÂâç' }
            ]
        };
        
        return changes[ledgerType] || [];
    }

    /**
     * Áî≥Ë´ãÊúüÈôê„ÇíÁîüÊàê
     */
    function generateDeadline() {
        const deadline = new Date();
        deadline.setDate(deadline.getDate() + Math.floor(Math.random() * 30) + 1);
        return deadline.toISOString().split('T')[0];
    }

    // =============================================================================
    // üîç „Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÉªÊ§úÁ¥¢
    // =============================================================================

    /**
     * „Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
     */
    function applyFilters() {
        let filtered = [...historyData];
        
        // Ë°®Á§∫ÁØÑÂõ≤„Éï„Ç£„É´„Çø
        const viewScope = document.querySelector('input[name="view-scope"]:checked').value;
        if (viewScope === 'my') {
            filtered = filtered.filter(record => record.updater === currentUser);
        } else if (viewScope === 'team') {
            // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ„ÉÅ„Éº„É†„É°„É≥„Éê„Éº„ÅÆ„É™„Çπ„Éà„Çí‰ΩøÁî®
            filtered = filtered.filter(record => record.updater !== currentUser);
        }
        
        // Êó•‰ªòÁØÑÂõ≤„Éï„Ç£„É´„Çø
        const dateFrom = elements.dateFrom.value;
        const dateTo = elements.dateTo.value;
        
        if (dateFrom) {
            filtered = filtered.filter(record => 
                new Date(record.update_date) >= new Date(dateFrom)
            );
        }
        
        if (dateTo) {
            const endDate = new Date(dateTo);
            endDate.setHours(23, 59, 59, 999);
            filtered = filtered.filter(record => 
                new Date(record.update_date) <= endDate
            );
        }
        
        // Âè∞Â∏≥Á®ÆÂà•„Éï„Ç£„É´„Çø
        const ledgerType = elements.ledgerFilter.value;
        if (ledgerType) {
            filtered = filtered.filter(record => record.ledger_type === ledgerType);
        }
        
        // Áî≥Ë´ãÁä∂Ê≥Å„Éï„Ç£„É´„Çø
        const applicationStatus = elements.applicationStatusFilter.value;
        if (applicationStatus) {
            filtered = filtered.filter(record => record.application_status === applicationStatus);
        }
        
        // Ê§úÁ¥¢„Éï„Ç£„É´„Çø
        const searchTerm = elements.searchInput.value.toLowerCase().trim();
        if (searchTerm) {
            filtered = filtered.filter(record => {
                return (
                    record.record_key.toLowerCase().includes(searchTerm) ||
                    record.application_number.toLowerCase().includes(searchTerm) ||
                    record.changes.some(change => 
                        change.field.toLowerCase().includes(searchTerm) ||
                        change.old.toLowerCase().includes(searchTerm) ||
                        change.new.toLowerCase().includes(searchTerm)
                    ) ||
                    record.notes.toLowerCase().includes(searchTerm)
                );
            });
        }
        
        filteredData = filtered;
        currentPage = 1;
        selectedRows.clear();
        
        sortData();
        renderTable();
        updatePagination();
        updateActionButtons();
    }

    /**
     * „Éï„Ç£„É´„Çø„Çí„ÇØ„É™„Ç¢
     */
    function clearFilters() {
        elements.dateFrom.value = '';
        elements.dateTo.value = '';
        elements.ledgerFilter.value = '';
        elements.applicationStatusFilter.value = '';
        elements.searchInput.value = '';
        
        document.querySelector('input[name="view-scope"][value="my"]').checked = true;
        
        applyFilters();
    }

    /**
     * Ë°®Á§∫ÁØÑÂõ≤Â§âÊõ¥„Éè„É≥„Éâ„É©
     */
    function handleViewScopeChange() {
        applyFilters();
    }

    // =============================================================================
    // üìã „ÉÜ„Éº„Éñ„É´Ë°®Á§∫
    // =============================================================================

    /**
     * „Éá„Éº„Çø„Çí„ÇΩ„Éº„Éà
     */
    function sortData() {
        filteredData.sort((a, b) => {
            let aValue = a[sortColumn];
            let bValue = b[sortColumn];
            
            // Êó•‰ªò„ÅÆÂ†¥Âêà
            if (sortColumn === 'update_date') {
                aValue = new Date(aValue);
                bValue = new Date(bValue);
            }
            
            // ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà
            if (typeof aValue === 'string') {
                aValue = aValue.toLowerCase();
                bValue = bValue.toLowerCase();
            }
            
            let result = 0;
            if (aValue < bValue) result = -1;
            if (aValue > bValue) result = 1;
            
            return sortDirection === 'desc' ? -result : result;
        });
    }

    /**
     * „ÉÜ„Éº„Éñ„É´„ÇíÊèèÁîª
     */
    function renderTable() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = filteredData.slice(startIndex, endIndex);
        
        elements.historyTableBody.innerHTML = '';
        
        pageData.forEach(record => {
            const row = createTableRow(record);
            elements.historyTableBody.appendChild(row);
        });
        
        // ÂÖ®ÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        updateSelectAllCheckbox();
    }

    /**
     * „ÉÜ„Éº„Éñ„É´Ë°å„Çí‰ΩúÊàê
     */
    function createTableRow(record) {
        const row = document.createElement('tr');
        row.dataset.recordId = record.id;
        
        if (selectedRows.has(record.id)) {
            row.classList.add('selected');
        }
        
        row.innerHTML = `
            <td class="checkbox-col">
                <input type="checkbox" class="row-checkbox" ${selectedRows.has(record.id) ? 'checked' : ''}>
            </td>
            <td>${formatDateTime(record.update_date)}</td>
            <td>${record.updater}</td>
            <td>${getLedgerDisplayName(record.ledger_type)}</td>
            <td>${record.record_key}</td>
            <td>${formatChanges(record.changes)}</td>
            <td>${createStatusBadge(record.application_status)}</td>
            <td>${record.application_number || '-'}</td>
            <td>${record.application_deadline ? formatDate(record.application_deadline) : '-'}</td>
            <td>
                <button class="operation-btn detail-btn" data-record-id="${record.id}">Ë©≥Á¥∞</button>
                ${record.application_status !== 'not_required' && record.application_status !== 'completed' ? 
                    `<button class="operation-btn primary application-btn" data-record-id="${record.id}">Áî≥Ë´ãÁôªÈå≤</button>` : 
                    ''
                }
            </td>
        `;
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
        const checkbox = row.querySelector('.row-checkbox');
        checkbox.addEventListener('change', (e) => handleRowSelect(e, record.id));
        
        const detailBtn = row.querySelector('.detail-btn');
        detailBtn.addEventListener('click', () => showDetailModal(record));
        
        const applicationBtn = row.querySelector('.application-btn');
        if (applicationBtn) {
            applicationBtn.addEventListener('click', () => showApplicationModal(record));
        }
        
        return row;
    }

    /**
     * Êó•ÊôÇ„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
     */
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    /**
     * Êó•‰ªò„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
     */
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('ja-JP');
    }

    /**
     * Âè∞Â∏≥Ë°®Á§∫Âêç„ÇíÂèñÂæó
     */
    function getLedgerDisplayName(ledgerType) {
        const names = {
            'SEAT': 'Â∫ßÂ∏≠Âè∞Â∏≥',
            'PC': 'PCÂè∞Â∏≥',
            'EXT': 'ÂÜÖÁ∑öÂè∞Â∏≥',
            'USER': '„É¶„Éº„Ç∂„ÉºÂè∞Â∏≥'
        };
        return names[ledgerType] || ledgerType;
    }

    /**
     * Â§âÊõ¥ÂÜÖÂÆπ„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
     */
    function formatChanges(changes) {
        if (!changes || changes.length === 0) return '-';
        
        return changes.map(change => 
            `${change.field}: ${change.old} ‚Üí ${change.new}`
        ).join('<br>');
    }

    /**
     * Áî≥Ë´ãÁä∂Ê≥Å„Éê„ÉÉ„Ç∏„Çí‰ΩúÊàê
     */
    function createStatusBadge(status) {
        const statusInfo = {
            'not_required': { text: 'Áî≥Ë´ã‰∏çË¶Å', icon: '‚ûñ' },
            'pending': { text: 'Êú™Áî≥Ë´ã', icon: '‚è≥' },
            'in_progress': { text: 'Áî≥Ë´ã‰∏≠', icon: 'üîÑ' },
            'completed': { text: 'Áî≥Ë´ãÂÆå‰∫Ü', icon: '‚úÖ' },
            'overdue': { text: 'ÊúüÈôêË∂ÖÈÅé', icon: '‚ö†Ô∏è' }
        };
        
        const info = statusInfo[status] || { text: '‰∏çÊòé', icon: '‚ùì' };
        return `<span class="status-badge ${status}">${info.icon} ${info.text}</span>`;
    }

    // =============================================================================
    // üìä Áµ±Ë®àÊÉÖÂ†±
    // =============================================================================

    /**
     * Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
     */
    function updateStatistics() {
        const stats = calculateStatistics();
        
        elements.totalUpdates.textContent = stats.total.toLocaleString();
        elements.pendingApplications.textContent = stats.pending.toLocaleString();
        elements.completedApplications.textContent = stats.completed.toLocaleString();
        elements.overdueApplications.textContent = stats.overdue.toLocaleString();
    }

    /**
     * Áµ±Ë®àÊÉÖÂ†±„ÇíË®àÁÆó
     */
    function calculateStatistics() {
        const total = filteredData.length;
        const pending = filteredData.filter(r => r.application_status === 'pending').length;
        const completed = filteredData.filter(r => r.application_status === 'completed').length;
        const overdue = filteredData.filter(r => {
            if (r.application_status !== 'pending' && r.application_status !== 'in_progress') return false;
            if (!r.application_deadline) return false;
            return new Date(r.application_deadline) < new Date();
        }).length;
        
        return { total, pending, completed, overdue };
    }

    // =============================================================================
    // üéØ „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
    // =============================================================================

    /**
     * „Éá„Éº„ÇøÊõ¥Êñ∞„Éè„É≥„Éâ„É©
     */
    function handleRefresh() {
        loadHistoryData();
    }

    /**
     * „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éè„É≥„Éâ„É©
     */
    function handleExport() {
        try {
            const csvData = generateCSV(filteredData);
            downloadCSV(csvData, `Êõ¥Êñ∞Â±•Ê≠¥_${new Date().toISOString().split('T')[0]}.csv`);
            showSuccess('„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü„ÄÇ');
        } catch (error) {
            console.error('‚ùå „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', error);
            showError('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        }
    }

    /**
     * „ÇΩ„Éº„Éà„Éè„É≥„Éâ„É©
     */
    function handleSort(e) {
        const column = e.currentTarget.dataset.sort;
        
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'desc';
        }
        
        // „ÇΩ„Éº„Éà„Ç¢„Ç§„Ç≥„É≥„ÇíÊõ¥Êñ∞
        document.querySelectorAll('.sortable').forEach(header => {
            header.classList.remove('sorted');
            const icon = header.querySelector('.sort-icon');
            icon.textContent = '‚ÜïÔ∏è';
        });
        
        e.currentTarget.classList.add('sorted');
        const icon = e.currentTarget.querySelector('.sort-icon');
        icon.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
        
        sortData();
        renderTable();
    }

    /**
     * Ë°åÈÅ∏Êäû„Éè„É≥„Éâ„É©
     */
    function handleRowSelect(e, recordId) {
        const row = e.target.closest('tr');
        
        if (e.target.checked) {
            selectedRows.add(recordId);
            row.classList.add('selected');
        } else {
            selectedRows.delete(recordId);
            row.classList.remove('selected');
        }
        
        updateSelectAllCheckbox();
        updateActionButtons();
    }

    /**
     * ÂÖ®ÈÅ∏Êäû„Éè„É≥„Éâ„É©
     */
    function handleSelectAll(e) {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        const rows = document.querySelectorAll('#history-table-body tr');
        
        if (e.target.checked) {
            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = true;
                const recordId = rows[index].dataset.recordId;
                selectedRows.add(recordId);
                rows[index].classList.add('selected');
            });
        } else {
            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = false;
                const recordId = rows[index].dataset.recordId;
                selectedRows.delete(recordId);
                rows[index].classList.remove('selected');
            });
        }
        
        updateActionButtons();
    }

    /**
     * ‰∏ÄÊã¨Áî≥Ë´ãÁôªÈå≤„Éè„É≥„Éâ„É©
     */
    function handleBulkApplication() {
        if (selectedRows.size === 0) {
            showError('Áî≥Ë´ãÁôªÈå≤„Åô„ÇãÈ†ÖÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            return;
        }
        
        const selectedRecords = filteredData.filter(record => selectedRows.has(record.id));
        const applicableRecords = selectedRecords.filter(record => 
            record.application_status !== 'not_required' && record.application_status !== 'completed'
        );
        
        if (applicableRecords.length === 0) {
            showError('Áî≥Ë´ãÂèØËÉΩ„Å™È†ÖÁõÆ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
            return;
        }
        
        showBulkApplicationModal(applicableRecords);
    }

    /**
     * ÂÆå‰∫Ü„Éû„Éº„ÇØ„Éè„É≥„Éâ„É©
     */
    function handleMarkCompleted() {
        if (selectedRows.size === 0) {
            showError('ÂÆå‰∫Ü„Éû„Éº„ÇØ„Åô„ÇãÈ†ÖÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            return;
        }
        
        if (confirm(`ÈÅ∏Êäû„Åó„Åü${selectedRows.size}‰ª∂„ÇíÁî≥Ë´ãÂÆå‰∫Ü„Å®„Åó„Å¶„Éû„Éº„ÇØ„Åó„Åæ„Åô„ÅãÔºü`)) {
            markAsCompleted(Array.from(selectedRows));
        }
    }

    /**
     * „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Éè„É≥„Éâ„É©
     */
    function handleKeyDown(e) {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
                case 'r':
                    e.preventDefault();
                    handleRefresh();
                    break;
                case 'e':
                    e.preventDefault();
                    handleExport();
                    break;
                case 'f':
                    e.preventDefault();
                    elements.searchInput.focus();
                    break;
            }
        }
        
        if (e.key === 'Escape') {
            closeApplicationModal();
            closeDetailModal();
        }
    }

    // =============================================================================
    // üìÑ „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥
    // =============================================================================

    /**
     * „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
     */
    function updatePagination() {
        const totalItems = filteredData.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
        
        // ÊÉÖÂ†±„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
        if (totalItems === 0) {
            elements.paginationInfoText.textContent = '0‰ª∂';
        } else {
            elements.paginationInfoText.textContent = 
                `${startIndex.toLocaleString()}-${endIndex.toLocaleString()} / ${totalItems.toLocaleString()}‰ª∂`;
        }
        
        // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        elements.prevPageBtn.disabled = currentPage <= 1;
        elements.nextPageBtn.disabled = currentPage >= totalPages;
        
        // „Éö„Éº„Ç∏Áï™Âè∑„ÇíÁîüÊàê
        generatePageNumbers(totalPages);
    }

    /**
     * „Éö„Éº„Ç∏Áï™Âè∑„ÇíÁîüÊàê
     */
    function generatePageNumbers(totalPages) {
        elements.pageNumbers.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        const maxVisible = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages, startPage + maxVisible - 1);
        
        if (endPage - startPage + 1 < maxVisible) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.addEventListener('click', () => changePage(i));
            elements.pageNumbers.appendChild(pageBtn);
        }
    }

    /**
     * „Éö„Éº„Ç∏„ÇíÂ§âÊõ¥
     */
    function changePage(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        renderTable();
        updatePagination();
        
        // „ÉÜ„Éº„Éñ„É´„ÅÆÂÖàÈ†≠„Å´„Çπ„ÇØ„É≠„Éº„É´
        elements.historyTable.scrollIntoView({ behavior: 'smooth' });
    }

    // =============================================================================
    // üîß „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
    // =============================================================================

    /**
     * ÂÖ®ÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞
     */
    function updateSelectAllCheckbox() {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
        
        if (checkedCount === 0) {
            elements.selectAllCheckbox.indeterminate = false;
            elements.selectAllCheckbox.checked = false;
        } else if (checkedCount === checkboxes.length) {
            elements.selectAllCheckbox.indeterminate = false;
            elements.selectAllCheckbox.checked = true;
        } else {
            elements.selectAllCheckbox.indeterminate = true;
            elements.selectAllCheckbox.checked = false;
        }
    }

    /**
     * „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
     */
    function updateActionButtons() {
        const hasSelection = selectedRows.size > 0;
        elements.bulkApplicationBtn.disabled = !hasSelection;
        elements.markCompletedBtn.disabled = !hasSelection;
    }

    /**
     * CSV„Éá„Éº„Çø„ÇíÁîüÊàê
     */
    function generateCSV(data) {
        const headers = [
            'Êõ¥Êñ∞Êó•ÊôÇ', 'Êõ¥Êñ∞ËÄÖ', 'Âè∞Â∏≥Á®ÆÂà•', '„É¨„Ç≥„Éº„Éâ„Ç≠„Éº', 'Êõ¥Êñ∞ÂÜÖÂÆπ',
            'Áî≥Ë´ãÁä∂Ê≥Å', 'Áî≥Ë´ãÁï™Âè∑', 'Áî≥Ë´ãÊúüÈôê', 'ÂÇôËÄÉ'
        ];
        
        const rows = data.map(record => [
            formatDateTime(record.update_date),
            record.updater,
            getLedgerDisplayName(record.ledger_type),
            record.record_key,
            record.changes.map(c => `${c.field}: ${c.old} ‚Üí ${c.new}`).join('; '),
            getStatusText(record.application_status),
            record.application_number || '',
            record.application_deadline ? formatDate(record.application_deadline) : '',
            record.notes || ''
        ]);
        
        const csvContent = [headers, ...rows]
            .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            .join('\n');
        
        return '\uFEFF' + csvContent; // BOM‰ªò„ÅçUTF-8
    }

    /**
     * CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
     */
    function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    /**
     * Áî≥Ë´ãÁä∂Ê≥Å„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæó
     */
    function getStatusText(status) {
        const statusTexts = {
            'not_required': 'Áî≥Ë´ã‰∏çË¶Å',
            'pending': 'Êú™Áî≥Ë´ã',
            'in_progress': 'Áî≥Ë´ã‰∏≠',
            'completed': 'Áî≥Ë´ãÂÆå‰∫Ü',
            'overdue': 'ÊúüÈôêË∂ÖÈÅé'
        };
        return statusTexts[status] || '‰∏çÊòé';
    }

    /**
     * „Éá„Éê„Ç¶„É≥„ÇπÈñ¢Êï∞
     */
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    /**
     * „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫Âà∂Âæ°
     */
    function showLoading(show) {
        elements.loadingOverlay.style.display = show ? 'flex' : 'none';
    }

    /**
     * „Ç®„É©„ÉºË°®Á§∫
     */
    function showError(message) {
        alert(`„Ç®„É©„Éº: ${message}`);
    }

    /**
     * ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
     */
    function showSuccess(message) {
        alert(`ÊàêÂäü: ${message}`);
    }

    // =============================================================================
    // üîç „É¢„Éº„ÉÄ„É´Ê©üËÉΩ
    // =============================================================================

    /**
     * Áî≥Ë´ãÁôªÈå≤„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
     */
    function showApplicationModal(record) {
        elements.applicationNumber.value = record.application_number || '';
        elements.applicationDeadline.value = record.application_deadline || '';
        elements.applicationNotes.value = record.notes || '';
        
        elements.applicationModal.dataset.recordId = record.id;
        elements.applicationModal.style.display = 'block';
        elements.applicationNumber.focus();
    }

    /**
     * Áî≥Ë´ãÁôªÈå≤„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
     */
    function closeApplicationModal() {
        elements.applicationModal.style.display = 'none';
        elements.applicationModal.removeAttribute('data-record-id');
        
        // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
        elements.applicationNumber.value = '';
        elements.applicationDeadline.value = '';
        elements.applicationNotes.value = '';
    }

    /**
     * Áî≥Ë´ãÊÉÖÂ†±„Çí‰øùÂ≠ò
     */
    async function saveApplicationInfo() {
        const recordId = elements.applicationModal.dataset.recordId;
        const applicationNumber = elements.applicationNumber.value.trim();
        const applicationDeadline = elements.applicationDeadline.value;
        const notes = elements.applicationNotes.value.trim();
        
        if (!applicationNumber) {
            showError('Áî≥Ë´ãÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            return;
        }
        
        try {
            showLoading(true);
            
            // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ kintone API „Çí‰ΩøÁî®„Åó„Å¶„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            await updateApplicationInfo(recordId, {
                application_number: applicationNumber,
                application_deadline: applicationDeadline,
                application_status: 'in_progress',
                notes: notes
            });
            
            // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            const record = historyData.find(r => r.id === recordId);
            if (record) {
                record.application_number = applicationNumber;
                record.application_deadline = applicationDeadline;
                record.application_status = 'in_progress';
                record.notes = notes;
            }
            
            closeApplicationModal();
            applyFilters();
            updateStatistics();
            showSuccess('Áî≥Ë´ãÊÉÖÂ†±„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü„ÄÇ');
            
        } catch (error) {
            console.error('‚ùå Áî≥Ë´ãÊÉÖÂ†±‰øùÂ≠ò„Ç®„É©„Éº:', error);
            showError('Áî≥Ë´ãÊÉÖÂ†±„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        } finally {
            showLoading(false);
        }
    }

    /**
     * Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
     */
    function showDetailModal(record) {
        elements.detailModalBody.innerHTML = createDetailContent(record);
        elements.detailModal.style.display = 'block';
    }

    /**
     * Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
     */
    function closeDetailModal() {
        elements.detailModal.style.display = 'none';
    }

    /**
     * Ë©≥Á¥∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí‰ΩúÊàê
     */
    function createDetailContent(record) {
        return `
            <div class="detail-section">
                <h4 class="detail-section-title">Âü∫Êú¨ÊÉÖÂ†±</h4>
                <div class="detail-grid">
                    <div class="detail-label">Êõ¥Êñ∞Êó•ÊôÇ:</div>
                    <div class="detail-value">${formatDateTime(record.update_date)}</div>
                    <div class="detail-label">Êõ¥Êñ∞ËÄÖ:</div>
                    <div class="detail-value">${record.updater}</div>
                    <div class="detail-label">Âè∞Â∏≥Á®ÆÂà•:</div>
                    <div class="detail-value">${getLedgerDisplayName(record.ledger_type)}</div>
                    <div class="detail-label">„É¨„Ç≥„Éº„Éâ„Ç≠„Éº:</div>
                    <div class="detail-value">${record.record_key}</div>
                </div>
            </div>
            
            <div class="detail-section">
                <h4 class="detail-section-title">Êõ¥Êñ∞ÂÜÖÂÆπ</h4>
                <ul class="change-list">
                    ${record.changes.map(change => `
                        <li class="change-item">
                            <div class="change-field">${change.field}</div>
                            <div class="change-values">
                                <span class="old-value">${change.old}</span> ‚Üí 
                                <span class="new-value">${change.new}</span>
                            </div>
                        </li>
                    `).join('')}
                </ul>
            </div>
            
            <div class="detail-section">
                <h4 class="detail-section-title">Áî≥Ë´ãÊÉÖÂ†±</h4>
                <div class="detail-grid">
                    <div class="detail-label">Áî≥Ë´ãÁä∂Ê≥Å:</div>
                    <div class="detail-value">${createStatusBadge(record.application_status)}</div>
                    <div class="detail-label">Áî≥Ë´ãÁï™Âè∑:</div>
                    <div class="detail-value">${record.application_number || '-'}</div>
                    <div class="detail-label">Áî≥Ë´ãÊúüÈôê:</div>
                    <div class="detail-value">${record.application_deadline ? formatDate(record.application_deadline) : '-'}</div>
                    <div class="detail-label">ÂÇôËÄÉ:</div>
                    <div class="detail-value">${record.notes || '-'}</div>
                </div>
            </div>
        `;
    }

    // =============================================================================
    // üîÑ „Éá„Éº„ÇøÊõ¥Êñ∞Ê©üËÉΩ
    // =============================================================================

    /**
     * Áî≥Ë´ãÊÉÖÂ†±„ÇíÊõ¥Êñ∞Ôºà„Çµ„É≥„Éó„É´ÂÆüË£ÖÔºâ
     */
    async function updateApplicationInfo(recordId, updateData) {
        // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ kintone API „Çí‰ΩøÁî®
        return new Promise((resolve) => {
            setTimeout(() => {
                console.log('Áî≥Ë´ãÊÉÖÂ†±Êõ¥Êñ∞:', recordId, updateData);
                resolve();
            }, 500);
        });
    }

    /**
     * ÂÆå‰∫Ü„Éû„Éº„ÇØ„ÇíË®≠ÂÆö
     */
    async function markAsCompleted(recordIds) {
        try {
            showLoading(true);
            
            // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ kintone API „Çí‰ΩøÁî®
            await Promise.all(recordIds.map(id => 
                updateApplicationInfo(id, { application_status: 'completed' })
            ));
            
            // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            recordIds.forEach(id => {
                const record = historyData.find(r => r.id === id);
                if (record) {
                    record.application_status = 'completed';
                }
            });
            
            selectedRows.clear();
            applyFilters();
            updateStatistics();
            showSuccess(`${recordIds.length}‰ª∂„ÇíÁî≥Ë´ãÂÆå‰∫Ü„Å®„Åó„Å¶„Éû„Éº„ÇØ„Åó„Åæ„Åó„Åü„ÄÇ`);
            
        } catch (error) {
            console.error('‚ùå ÂÆå‰∫Ü„Éû„Éº„ÇØË®≠ÂÆö„Ç®„É©„Éº:', error);
            showError('ÂÆå‰∫Ü„Éû„Éº„ÇØ„ÅÆË®≠ÂÆö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
        } finally {
            showLoading(false);
        }
    }

    // =============================================================================
    // üåê „Ç∞„É≠„Éº„Éê„É´ÂÖ¨Èñã
    // =============================================================================

    // Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„Çí„Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
    window.HistorySystem = {
        init: initHistorySystem,
        loadData: loadHistoryData,
        applyFilters: applyFilters,
        exportData: handleExport
    };

    // DOMË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´ÂàùÊúüÂåñ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initHistorySystem);
    } else {
        initHistorySystem();
    }

    console.log('‚úÖ Êõ¥Êñ∞Â±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† JavaScript Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü');

})(); 