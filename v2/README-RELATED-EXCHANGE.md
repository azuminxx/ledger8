# 🔄 主キー交換時の関連フィールド一括交換機能

## 📋 概要

v2システムの`CellSwapManager`に、主キー交換時に同じ台帳の関連フィールドを一括で交換する機能を実装しました。

## ✨ 機能詳細

### 🎯 **従来の動作**
- 主キーセルをドラッグ&ドロップで交換
- **単一のセルの値のみが交換される**

### 🔄 **新しい動作**
- 主キーセルをドラッグ&ドロップで交換
- **同じsourceAppの関連フィールドがすべて一括で交換される**
- **レコードIDフィールドも自動的に交換される**
- **交換後に空になった行は自動的に削除される**

## 🏗️ 実装詳細

### **主要メソッド**

#### `_performRelatedFieldsExchange(sourceCell, targetCell)`
- 関連フィールド一括交換のメイン処理
- ソースとターゲットの行を取得
- フィールド情報から`sourceApp`を特定
- 関連フィールドリストを取得して一括交換実行

#### `_getRelatedFields(sourceApp)`
- 指定された`sourceApp`に属するフィールドを`fieldsConfig`から取得
- レコードIDフィールドは除外（別途処理）

#### `_findCellInRow(row, fieldCode)`
- 行内の指定されたフィールドのセルを検索

#### `_exchangeSingleField(sourceCell, targetCell)`
- 個別フィールドの値交換を実行
- `CellValueHelper`を使用して安全に値を交換

#### `_removeEmptyRowsAfterExchange(rows)`
- 交換後に空になった行を自動削除
- 重要フィールドの値をチェックして空行を判定

#### `_isRowEmpty(row)`
- 行が空かどうかを判定
- 行番号以外の重要フィールドに値があるかチェック

#### `_extractCellValue(cell)`
- セルから値を安全に抽出
- 入力要素、分離ボタン付きセル、通常セルに対応

#### `_updateRowNumbers()`
- 行削除後の行番号を更新
- data-row-id属性も同時に更新

## 📊 交換対象フィールド

### **座席番号を交換した場合**
```javascript
交換対象: [
  '座席番号',           // 主キーフィールド
  '座席エリア',         // 座席台帳の関連フィールド
  '座席タイプ',         // 座席台帳の関連フィールド
  'seat_record_id'      // 座席台帳のレコードID
]
```

### **PC番号を交換した場合**
```javascript
交換対象: [
  'PC番号',             // 主キーフィールド
  'PC用途',             // PC台帳の関連フィールド
  'PCスペック',         // PC台帳の関連フィールド
  'pc_record_id'        // PC台帳のレコードID
]
```

## 🔧 技術仕様

### **依存関係**
- `window.fieldsConfig` - フィールド設定情報
- `CellValueHelper` - セル値の取得・設定
- `CommonHighlightHelper` - ハイライト処理

### **ハイライト処理**
- 交換されたすべてのセルに対してハイライトを適用
- `CommonHighlightHelper.updateMultipleCellsHighlight()`を使用

### **エラーハンドリング**
- フィールド情報が見つからない場合
- 行が見つからない場合
- セル値の取得・設定エラー

## 🧪 テスト

### **テストファイル**
- `test-related-exchange.html` - 機能テスト用のHTMLファイル

### **テスト項目**
1. **関連フィールド取得テスト**
   - `_getRelatedFields()`の動作確認
   - SEAT/PC台帳の関連フィールドが正しく取得されるか

2. **セル検索テスト**
   - `_findCellInRow()`の動作確認
   - 行内のフィールドが正しく検索されるか

3. **単一フィールド交換テスト**
   - `_exchangeSingleField()`の動作確認
   - 値が正しく交換されるか

4. **空行判定テスト**
   - `_isRowEmpty()`の動作確認
   - 値ありの行、値なしの行を正しく判定できるか

5. **空行削除テスト**
   - `_removeEmptyRowsAfterExchange()`の動作確認
   - 空行が正しく削除され、行番号が更新されるか

## 🔄 レガシーシステムとの互換性

### **レガシーシステムの実装**
- `legacy/02-utilities.js`の`CellExchangeManager._performFieldExchange()`
- 同様の関連フィールド一括交換機能が既に実装済み

### **v2システムの実装**
- レガシーの実装を参考に、v2のアーキテクチャに適合させて実装
- 同じロジックを使用して一貫性を保持

## 📝 使用例

```javascript
// 主キーセルをドラッグ&ドロップで交換
// 座席番号 A-001 ⇔ B-002 を交換

// 実行前の状態
行1: { 座席番号: "A-001", 座席エリア: "フロア1-北", seat_record_id: "SEAT-12345" }
行2: { 座席番号: "B-002", 座席エリア: "フロア2-南", seat_record_id: "SEAT-54321" }

// 実行後の状態（関連フィールドも一括交換）
行1: { 座席番号: "B-002", 座席エリア: "フロア2-南", seat_record_id: "SEAT-54321" }
行2: { 座席番号: "A-001", 座席エリア: "フロア1-北", seat_record_id: "SEAT-12345" }
```

## 🎨 ログ出力

```
🔄 関連フィールド一括交換開始
📝 交換対象フィールド: 座席番号, 座席エリア, seat_record_id
  🔄 フィールド交換: 座席番号 "A-001" ⇔ "B-002"
  🔄 フィールド交換: 座席エリア "フロア1-北" ⇔ "フロア2-南"
  🔄 フィールド交換: seat_record_id "SEAT-12345" ⇔ "SEAT-54321"
✅ 関連フィールド一括交換完了: 3フィールド, 6セル
🗑️ 交換後空行削除チェック開始
🔍 空行判定: 行番号 1 = 値あり
🔍 空行判定: 行番号 2 = 値あり
ℹ️ 削除対象の空行なし
✅ セル交換ハイライト更新完了: 6セル
``` 